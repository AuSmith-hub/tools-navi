<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ¨é—¨å·¥å…·å¯¼èˆª</title>
    <!-- Bootstrap 5 CSS -->
    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .top-header {
            background-color: #f8f9fa;
            padding: 8px 0;
            transition: all 0.3s ease;
            z-index: 1020;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .top-header.collapsed {
            padding: 4px 0;
        }
        
        .tools-list-container {
            height: calc(100vh - 100px);
            overflow-y: auto;
        }
        
        .back-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1030;
            cursor: move;
            transition: opacity 0.3s;
            display: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #0d6efd;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        .back-to-top:hover {
            background-color: #0b5ed7;
            transform: translateY(-2px);
        }
        
        .tool-item {
            border-left: 0;
            border-right: 0;
            padding: 15px 20px;
            transition: background-color 0.2s;
        }
        
        .tool-item:hover {
            background-color: #f8f9fa;
        }
        
        .tool-item:first-child {
            border-top: 0;
        }
        
        .tool-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .collapsed .tool-icon {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
        }
        
        .title-section {
            transition: all 0.3s ease;
        }
        
        .collapsed .title-section h5 {
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        .collapsed .title-section .text-muted {
            display: none;
        }
        
        .collapse-btn {
            transition: all 0.3s ease;
        }
        
        .collapsed .collapse-btn {
            transform: rotate(180deg);
        }
        
        .section-header {
            background-color: #e9ecef;
            padding: 8px 15px;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 5;
        }
        
        .tool-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .tool-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        /* è¿”å›æŒ‰é’®æ ·å¼ */
        .back-button {
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            transition: all 0.2s;
        }
        
        .back-button:hover {
            background-color: #5a6268;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="top-header sticky-top" id="topHeader">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center title-section">
                    <button class="back-button" id="backButton" title="è¿”å›é¦–é¡µ">
                        <span>ğŸ </span>
                    </button>
                    <div class="tool-icon me-3 bg-primary">ğŸ”§</div>
                    <div>
                        <h5 class="mb-0" id="page-title">éƒ¨é—¨å·¥å…·å¯¼èˆª</h5>
                        <small class="text-muted" id="page-description">è¯·é€‰æ‹©æ‚¨éœ€è¦çš„å·¥å…·</small>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-secondary collapse-btn" type="button" 
                        id="toggleHeaderBtn" aria-label="åˆ‡æ¢ä¿¡æ¯æ ">
                    <span>âˆ’</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="container-fluid p-0">
        <div class="tools-list-container" id="toolsList">
            <!-- å·¥å…·åˆ—è¡¨å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            <div class="d-flex justify-content-center align-items-center" style="height: 100%;">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
            </div>
        </div>
    </main>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" id="backToTop">â†‘</button>

    <!-- Bootstrap 5 JavaScript -->
    <script src="../bootstrap/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // è·å–URLå‚æ•°
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(window.location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // ä»æœ¬åœ°åŠ è½½JSONæ•°æ®
        async function loadJsonData(filePath) {
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                throw error;
            }
        }

        // åŠ è½½é…ç½®å’Œå·¥å…·æ•°æ®
        async function loadConfigAndToolsData(departmentKey) {
            try {
                // åŠ è½½é…ç½®æ–‡ä»¶
                const config = await loadJsonData('../data/config.json');
                
                // è·å–å¯¹åº”çš„æ–‡ä»¶è·¯å¾„
                const dataFile = config.departments[departmentKey];
                if (!dataFile) {
                    throw new Error('æ— æ•ˆçš„éƒ¨é—¨æ ‡è¯†');
                }
                
                // åŠ è½½æ•°æ®æ–‡ä»¶
                const data = await loadJsonData(`../${dataFile}`);
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜å’Œæè¿°
                const title = config.titles[departmentKey] || data.title || 'éƒ¨é—¨å·¥å…·å¯¼èˆª';
                document.getElementById('page-title').textContent = title;
                document.getElementById('page-description').textContent = data.description || 'è¯·é€‰æ‹©æ‚¨éœ€è¦çš„å·¥å…·';
                
                // æ¸²æŸ“å·¥å…·åˆ—è¡¨
                renderToolsList(data.items, departmentKey);
            } catch (error) {
                console.error('åŠ è½½å·¥å…·æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const toolsList = document.getElementById('toolsList');
                toolsList.innerHTML = `
                    <div class="alert alert-danger m-3">
                        <h4 class="alert-heading">æ•°æ®åŠ è½½å¤±è´¥</h4>
                        <p>${error.message}</p>
                        <hr>
                        <p class="mb-0">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“å·¥å…·åˆ—è¡¨
        function renderToolsList(items, departmentKey) {
            const toolsList = document.getElementById('toolsList');
            toolsList.innerHTML = '';
            
            // æŒ‰ç±»åˆ«åˆ†ç»„
            const groups = {};
            items.forEach(item => {
                const category = item.category || 'å…¶ä»–';
                if (!groups[category]) {
                    groups[category] = [];
                }
                groups[category].push(item);
            });
            
            // æ¸²æŸ“æ¯ä¸ªç±»åˆ«
            Object.keys(groups).sort().forEach(category => {
                // æ·»åŠ ç±»åˆ«æ ‡é¢˜
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.textContent = category;
                toolsList.appendChild(sectionHeader);
                
                // æ·»åŠ è¯¥ç±»åˆ«ä¸‹çš„å·¥å…·
                groups[category].forEach(item => {
                    const toolElement = document.createElement('div');
                    toolElement.className = 'card tool-item tool-card m-3';
                    toolElement.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="tool-icon me-3 bg-primary d-flex align-items-center justify-content-center">
                                        ${item.icon || 'ğŸ”§'}
                                    </div>
                                    <div>
                                        <h6 class="card-title mb-0">${item.name}</h6>
                                        <p class="card-text mb-0 text-muted small">${item.description}</p>
                                    </div>
                                </div>
                                <div>
                                    <span class="badge bg-secondary">${item.category}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°ä¿¡æ¯é¡µé¢
                    toolElement.addEventListener('click', function() {
                        // ä¿å­˜éƒ¨é—¨ä¿¡æ¯åˆ°sessionStorage
                        sessionStorage.setItem('currentDepartment', departmentKey);
                        window.location.href = './info.html?tool=' + encodeURIComponent(item.name);
                    });
                    
                    toolsList.appendChild(toolElement);
                });
            });
        }

        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // ä»URLå‚æ•°è·å–éƒ¨é—¨keyï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»sessionStorageè·å–
            let departmentKey = getUrlParameter('dept');
            if (!departmentKey) {
                departmentKey = sessionStorage.getItem('currentDepartment') || 'msc';
            } else {
                // ä¿å­˜éƒ¨é—¨ä¿¡æ¯åˆ°sessionStorage
                sessionStorage.setItem('currentDepartment', departmentKey);
            }
            
            // ä¸ºè¿”å›æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.getElementById('backButton').addEventListener('click', function() {
                window.location.href = '../index.html';
            });
            
            // åŠ è½½é…ç½®å’Œå·¥å…·æ•°æ®
            loadConfigAndToolsData(departmentKey);
            
            const topHeader = document.getElementById('topHeader');
            const backToTop = document.getElementById('backToTop');
            const toolsList = document.getElementById('toolsList');
            const toggleHeaderBtn = document.getElementById('toggleHeaderBtn');
            
            let lastScrollTop = 0;
            let isManuallyCollapsed = false;
            
            // åˆ‡æ¢é¡¶éƒ¨ä¿¡æ¯æ çŠ¶æ€
            function toggleHeader(collapse) {
                if (collapse) {
                    topHeader.classList.add('collapsed');
                    isManuallyCollapsed = true;
                } else {
                    topHeader.classList.remove('collapsed');
                    isManuallyCollapsed = false;
                }
            }
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            toolsList.addEventListener('scroll', function() {
                const scrollTop = toolsList.scrollTop;
                
                // æ˜¾ç¤º/éšè—å›åˆ°é¡¶éƒ¨æŒ‰é’®
                if (scrollTop > 300) {
                    backToTop.style.display = 'block';
                } else {
                    backToTop.style.display = 'none';
                }
                
                // æ£€æµ‹æ»šåŠ¨æ–¹å‘å¹¶æ§åˆ¶ä¿¡æ¯æ 
                if (scrollTop > lastScrollTop && scrollTop > 50 && !isManuallyCollapsed) {
                    // å‘ä¸‹æ»šåŠ¨ - æŠ˜å ä¿¡æ¯æ 
                    toggleHeader(true);
                }
                
                lastScrollTop = scrollTop;
            });
            
            // å›åˆ°é¡¶éƒ¨åŠŸèƒ½
            backToTop.addEventListener('click', function() {
                toolsList.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            });
            
            // æ‰‹åŠ¨åˆ‡æ¢é¡¶éƒ¨ä¿¡æ¯æ 
            toggleHeaderBtn.addEventListener('click', function() {
                toggleHeader(!topHeader.classList.contains('collapsed'));
            });
            
            // ä½¿å›åˆ°é¡¶éƒ¨æŒ‰é’®å¯æ‹–åŠ¨
            backToTop.setAttribute('draggable', 'true');
            let isDragging = false;
            let offsetX, offsetY;
            
            backToTop.addEventListener('dragstart', function(e) {
                isDragging = true;
                offsetX = e.clientX - backToTop.getBoundingClientRect().left;
                offsetY = e.clientY - backToTop.getBoundingClientRect().top;
                backToTop.style.opacity = '0.7';
            });
            
            backToTop.addEventListener('drag', function(e) {
                if (isDragging && e.clientX !== 0 && e.clientY !== 0) {
                    backToTop.style.left = (e.clientX - offsetX) + 'px';
                    backToTop.style.top = (e.clientY - offsetY) + 'px';
                }
            });
            
            backToTop.addEventListener('dragend', function() {
                isDragging = false;
                backToTop.style.opacity = '1';
            });
            
            // å…è®¸æŒ‰é’®åœ¨é¡µé¢å†…æ‹–åŠ¨
            document.addEventListener('dragover', function(e) {
                e.preventDefault(); // å…è®¸æ”¾ç½®
            });
        });
    </script>
</body>
</html>